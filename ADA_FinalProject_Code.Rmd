---
title: "ADA Final Project"
author: "Nathalia G."
date: "2025-11-26"
output:
  word_document: default
  html_document: default
---
---------
Intro
---------
This is an R markdown file containing the code for analysis for my final ADA 
project data. This will be a survival analysis where the outcome is colorectal
cancer survival time. We will examine the effect of medicaid on survival time
by race using a difference in difference study design. 

# Load libraries
```{r}
pacman::p_load(survival, ggfortify, survminer, ggplot2, readxl, tidyverse,janitor, table1, VIM, mice, dplyr, table1, patchwork, purrr, broom)
```

# Import data
```{r}
SEER_colorec_raw <- read_csv("/Users/madelinemccormick/Downloads/ADA_final_project_data.csv")
```

# Examining data structure
```{r}
sapply(SEER_colorec_raw, typeof)
```

-----------------
Data Cleaning
-----------------

# Cleaning names and selecting variables

```{r}
# Cleaning variable names then selecting variables
SEER_colorec_clean <- SEER_colorec_raw %>% 
# Selecting variables
  select(`Age recode with <1 year olds`, `Sex`, `Race and origin recode (NHW, NHB, NHAIAN, NHAPI, Hispanic)`, `Combined Summary Stage (2004+)`, `Time from diagnosis to treatment in days recode`, `Vital status recode (study cutoff used)`, `SEER cause-specific death classification`, `Median household income inflation adj to 2022`, `Rural-Urban Continuum Code`, `Survival months`, `Year of diagnosis`)

# Cleaning names 
SEER_colorec_clean <- SEER_colorec_clean %>% 
  clean_names()

# Changing variable names to shorten
SEER_colorec_clean <- SEER_colorec_clean %>% 
  rename(age_raw = age_recode_with_1_year_olds) %>% 
  rename(race_raw = race_and_origin_recode_nhw_nhb_nhaian_nhapi_hispanic) %>% 
  rename(stage_raw = combined_summary_stage_2004) %>% 
  rename(time_to_treatment_raw =  time_from_diagnosis_to_treatment_in_days_recode) %>%
  rename(status_raw = vital_status_recode_study_cutoff_used)%>% 
  rename(cancer_specific_status_raw = seer_cause_specific_death_classification) %>%
  rename(income_raw =  median_household_income_inflation_adj_to_2022) %>% 
  rename(rural_urban_raw = rural_urban_continuum_code)
```

# Recoding variables 
```{r}
# Recoding categorical to either factor or numeric 
SEER_colorec_clean <- SEER_colorec_clean %>% 
  mutate(
    # Age (ordered factor)
    age_f = factor(
      age_raw,
      levels = c("20-24 years", "25-29 years", "30-34 years", 
                 "35-39 years", "40-44 years", "45-49 years", 
                 "50-54 years", "55-59 years", "60-64 years"),
                  ),
    # Sex
    sex_f = factor(
      sex,
      levels = c("Female", "Male")
                  ),
    # Race
    race_f = factor(
      race_raw,
      levels = c("Non-Hispanic White", "Non-Hispanic Black", 
                 "Non-Hispanic Asian or Pacific Islander",
                 "Non-Hispanic American Indian/Alaska Native",
                 "Hispanic (All Races)"),
      labels = c(
    "NHW",   # Non-Hispanic White
    "NHB",   # Non-Hispanic Black
    "NHAPI", # Non-Hispanic Asian/Pacific Islander
    "NHAIAN",# Non-Hispanic American Indian/Alaska Native
    "HIS"    # Hispanic (All)
  )
    ),
    # Stage (Unknown/unstaged becomes NA)
    stage_f = factor(
      ifelse(stage_raw %in% c("Unknown/unstaged", "In situ"), NA, stage_raw),
      levels = c("Localized", "Regional", "Distant"),
      ordered = TRUE
    ),
    # Time to treatment (convert to numeric, handle "Unable to calculate" as NA)
    time_to_treatment_num = as.numeric(
      ifelse(time_to_treatment_raw == "Unable to calculate", NA, time_to_treatment_raw)
    ),
    # Survival months (convert to numeric, handle "Unknown")
    survival_months_num = as.numeric(
      ifelse(survival_months == "Unknown", NA, survival_months)
    ),
    # Vital status (has to be numeric for surv purposes)
    status_num = case_when(
      status_raw == "Alive"~ 0,
      status_raw == "Dead" ~ 1
    ),
    # Income (collapsing into 3 categories for simplicity)
    income_f = factor(
      case_when(
        income_raw %in% c("< $40,000", "$40,000 - $44,999", "$45,000 - $49,999",
                      "$50,000 - $54,999") ~ "Low",
        income_raw %in% c("$55,000 - $59,999", "$60,000 - $64,999", "$65,000 - $69,999",
                      "$70,000 - $74,999", "$75,000 - $79,999", "$80,000 - $84,999") ~ "Medium",
        income_raw %in% c("$85,000 - $89,999", "$90,000 - $94,999", "$95,000 - $99,999",
                      "$100,000 - $109,999", "$110,000 - $119,999", "$120,000+") ~ "High",
        TRUE ~ NA_character_
        ),
      levels = c("Low", "Medium", "High")
    ),
    # Rural/Urban classification (recoding as binary)
    rural_urban_f = factor(
      ifelse(rural_urban_raw %in% c("Counties in metropolitan areas ge 1 million pop",
                                "Counties in metropolitan areas of 250,000 to 1 million pop",
                                "Counties in metropolitan areas of lt 250 thousand pop"),
         "Urban", "Rural"),
      levels = c("Urban", "Rural")
    )
  )
# Checking my work
# summary(SEER_colorec_clean)
```

# Creating the time period variable that will be used as an outcome
```{r}
SEER_colorec_clean <- SEER_colorec_clean %>%
  mutate(
    time_period_f = case_when(
      year_of_diagnosis >= 2010 & year_of_diagnosis <= 2013 ~ "Pre-Expansion",
      year_of_diagnosis >= 2016 & year_of_diagnosis <= 2019 ~ "Post-Expansion",
      TRUE ~ NA_character_  
    ),
    time_period_f = factor(time_period_f, levels = c("Pre-Expansion", "Post-Expansion"))
  )
# Checking work
summary(SEER_colorec_clean$time_period_f)
```

# Dropping NAs for variables that will be used in analysis 
```{r}
# I need to create two analytic datasets because I will examine trends later 
# and do not want to drop NAs that will created for those diagnosed in 2014
# and 2015 based on the time period variable. 
# Main Analysis
SEER_colorec_main <- SEER_colorec_clean %>% 
  drop_na(time_period_f, time_to_treatment_num, stage_f,
          survival_months_num, income_f)
# Trends Analysis (for keeping all years in analysis to quantify racial 
#disparities overall throughout the study period included)
SEER__colorec_trends <- SEER_colorec_clean %>% 
  drop_na(survival_months_num, status_num, race_f, sex_f, age_f)
```
------------------------
Descriptive Statistics
------------------------
NOTE: Add aesthethic characteristics to tables 

# Descriptive table stratified by time period

```{r}
label(SEER_colorec_main$age_f) <- "Age (years)"
label(SEER_colorec_main$sex_f) <- "Sex"
label(SEER_colorec_main$race_f) <- "Race"
label(SEER_colorec_main$stage_f) <- "Stage at diagnosis"
label(SEER_colorec_main$time_to_treatment_num) <- "Time to treatment (months)"
label(SEER_colorec_main$survival_months_num) <- "Survival time (months)"
label(SEER_colorec_main$status_raw) <- "Vital Status"
label(SEER_colorec_main$income_f) <- "Income"
label(SEER_colorec_main$rural_urban_f) <- "Rural/Urban County"
label(SEER_colorec_main$time_period_f) <- "Time Period"

table1(~ age_f + sex_f + race_f + stage_f + time_to_treatment_num + survival_months_num + 
       status_raw + income_f + rural_urban_f|time_period_f, SEER_colorec_main,
       caption = "<center><b>Table 1. Baseline Characteristics of Patients Diagnosed with Colorectal Cancer SEER 21 Registries <b>Stratified by Medicaid Expansion Period (Pre: 2010–2013; Post: 2016–2019)</b></center>",
      )
```

# Descriptive table stritified by race 
```{r}
table1(~ age_f + sex_f + stage_f + time_to_treatment_num + survival_months_num + 
       status_raw + income_f + rural_urban_f|race_f, SEER_colorec_main)
```

The numbers for Non-Hispanic American Indian/Alaska Native were too small and 
were making the models unstable later on in the analysis, so I decided to
exclude them from the datasets.

```{r}
SEER_colorec_main <- SEER_colorec_main %>%
  filter(race_f != "NHAIAN") %>%
  droplevels()   

SEER__colorec_trends <- SEER__colorec_trends %>%
  filter(race_f != "NHAIAN") %>%
  droplevels()
```




--------------------
Kaplan Meier Curves
--------------------

# Generating survival probabilities 
```{r include= FALSE}
# Overall survival
clrctl.surv <- survfit(Surv(survival_months_num, status_num) ~ 1, SEER_colorec_main)

summary(clrctl.surv) 

# Stratified by race
race.surv <- survfit(Surv(survival_months_num, status_num) ~ race_f, SEER_colorec_main)

summary(race.surv) 

# Stratified by race by time-period
    # Pre-Medicaid expansion
pre_data <- SEER_colorec_main %>% filter(time_period_f == "Pre-Expansion")

pre_race.surv <- survfit(Surv(survival_months_num, status_num) 
                         ~ race_f, data = pre_data)
    # Post-Medicaid expansion
post_data <- SEER_colorec_main %>% filter(time_period_f == "Post-Expansion")

post_race.surv <- survfit(Surv(survival_months_num, status_num) 
                          ~ race_f, data = post_data)
```

# K-M Curves 

NOTE: Give titles to plots that are missing them 
```{r}
# Overall 
overall.km <- ggsurvplot(clrctl.surv, data = SEER_colorec_main, 
                         conf.int=TRUE, pval = TRUE,  
                         tables.theme = clean_theme())
overall.km

# By race
race.km <- ggsurvplot(race.surv, data = SEER_colorec_main, 
                      conf.int=FALSE, pval = TRUE,  
                      tables.theme = clean_theme())
race.km

# Stratified by race by time-period
    # Pre-Medicaid expansion
pre_race.km <- ggsurvplot(pre_race.surv, data = pre_data, conf.int = FALSE,
                          pval = TRUE,
                          title = "Survival by Race – Pre-Expansion (2010–2013) vs. Post-Expansion (2016-2019)",
                          tables.theme = clean_theme(),
                          xlim = c(0, 80))
    # Post-Medicaid expansion
post_race.km <- ggsurvplot(post_race.surv, data = post_data, conf.int = FALSE,
                           pval = TRUE, 
                           tables.theme = clean_theme(),
                           xlim = c(0, 80))

# Mosaic side-by-side
pre_race.km$plot <- pre_race.km$plot +
  theme(legend.position = "top")
post_race.km$plot <- post_race.km$plot +
  theme(legend.position = "none", plot.title = element_blank())
options(repr.plot.width = 15, repr.plot.height = 10)
pre_race.km$plot + post_race.km$plot +
  plot_layout(nrow= 1)

```
From the graphs by time-period and curves stratified by race, it seems like 
overall survival improved for all races, but perhaps the disparities among
Black/African Americans vs. everyone else widened.

# Log rank test of racial differences before and after

```{r}
survdiff(Surv(survival_months_num, status_num) ~ race_f,
         data = pre_data)
survdiff(Surv(survival_months_num, status_num) ~ race_f,
         data = post_data)
```

Output doesn't feel super informative because the sample size is quite large. 
Will proceed to Cox instead of spending more time on log rank. 

----------------------------------
Primary Analysis: Cox Objective A
----------------------------------
Objective: to describe racial/ethnic disparities in overall colorectal cancer 
survival for the study period, unadjusted and adjusted by age and sex.
Since this is descriptive across the study period, I use the trends dataset
that won't drop 2014 and 2015 as transition years.

```{r}
# Unadjusted Cox Model
cox.objA.univar <- coxph(Surv(survival_months_num, status_num) ~ race_f, 
                         SEER__colorec_trends, ties="efron") 
summary(cox.objA.univar)

# Adjusted Cox Model
cox.objA.adj <- coxph(Surv(survival_months_num, status_num) ~ race_f + sex_f +
                                                              age_f, 
                         SEER__colorec_trends, ties="efron") 
summary(cox.objA.adj)
```
After adjusting for age and sex, it seems that there are significant racial 
disparities in colorectal cancer survival, with Black/AA individuals experiencing
the lowest survival rates and Asian/Pacific Islander individuals experiencing 
the highest survival rates. 

Adjusted ORs for each racial group: 
NHAPI	-- 13% lower hazard vs. NHW
NHW -- reference group
NHB	-- 33% higher hazard of death vs. NHW
NHAIAN	-- 25% higher hazard vs. NHW
Hispanic	-- 10% higher hazard vs. NHW

----------------------------------
Primary Analysis: Cox Objective B
----------------------------------
Objective: to determine whether the association between race/ethnicity and 
cancer survival differs between the pre-Medicaid expansion period (2010-2013) 
and post-Medicaid expansion period (2016-2019); using a difference in 
differences analysis, 
```{r}
# Unadjusted Cox Model
cox.objB.univar <- coxph(Surv(survival_months_num, status_num) ~ time_period_f +
                           race_f + time_period_f*race_f,
                           SEER_colorec_main, ties="efron") 
summary(cox.objB.univar)

# Adjusted Cox Model
cox.objB.adj <- coxph(Surv(survival_months_num, status_num) ~ time_period_f +
                           race_f + time_period_f*race_f 
                           # now adding covariates after the DiD term
                           + sex_f + age_f,
                           SEER_colorec_main, ties="efron") 
summary(cox.objB.adj)
```
Adjusted coefficients interpretation
- Time-period: After medicaid expansion the hazard of death among non-hispanic
whites decreased by 6% [HR = 0.94, 95% CI= 0.9170-0.9605].
- Race: before Medicaid expansion, Black, AIAN, and Hispanic patients had higher
mortality hazard compared with White patients, while API patients had lower 
mortality hazard (consistent with overall period analysis completed in 
objective A)
-Changes in disparities (DID and race interaction): most HRs (API, AIAN, HIS) 
were non-significant indicating no difference in the racial disparities between 
these racial groups and white individuals pre vs. post medicaid. 
  > However, the disparities between Black and White individuals actually 
  worsened. The hazard of death increased 6% more for Black patients relative to
  White patients in the post-expansion period (HR = 1.06; 95% CI: 1.0133-1.1109).
  
>> Basically, the model suggests that survival probabilities increased for all 
races except Black individuals. The improvement was proportional such that 
differences in survival among Asian, Hispanic, and American Indian racial groups
stayed the same. But there didn't seem to be differences in the survival of
Black individuals following Medicaid Expansion. 

-----------------------------------------------
Testing Assumptions for Adjusted Models A and B
-----------------------------------------------

# Linearity
No need to test since there are no continous predictor variables in either
model.

# Influential observations (using df betas)
The sample is so large that this would not run. I'm going to checking min and 
max dfbeta residual values.

```{r}
  # Model A
res <- residuals(cox.objA.adj, type = "dfbeta")
apply(res, 2, function(x) max(abs(x), na.rm=TRUE))

  # Model B
res <- residuals(cox.objB.adj, type = "dfbeta")
apply(res, 2, function(x) max(abs(x), na.rm=TRUE))

```
Cutoff for concern is 2/(sqrt{n}), which is 0.00487. 
Highest observed value was 0.00481. All values are under cut-off indicating no
influential observations.

# Test PH separately for each time period (Objective A)

```{r}
cat("=== OBJECTIVE A: PRE-EXPANSION PERIOD (2010-2013) ===\n\n")

cox.objA.pre <- coxph(Surv(survival_months_num, status_num) ~ race_f + sex_f + age_f, 
                       data = pre_data, ties="efron")

test.ph.A.pre <- cox.zph(cox.objA.pre, terms=FALSE)
print(test.ph.A.pre)

cat("\n=== OBJECTIVE A: POST-EXPANSION PERIOD (2016-2019) ===\n\n")

cox.objA.post <- coxph(Surv(survival_months_num, status_num) ~ race_f + sex_f + age_f, 
                        data = post_data, ties="efron")

test.ph.A.post <- cox.zph(cox.objA.post, terms=FALSE)
print(test.ph.A.post)
```
# Test PH for Objective B model

```{r}
test.ph.B <- cox.zph(cox.objB.adj, terms=FALSE)
print(test.ph.B)

test.ph.B.terms <- cox.zph(cox.objB.adj, terms=TRUE)
print(test.ph.B.terms)
```
# Parallel trends

```{r}
# Vector of all available diagnosis years (2010–2019)
years_vec <- sort(unique(SEER__colorec_trends$year_of_diagnosis))

# Fit one Cox model per year
yearly_results <- map_df(years_vec, function(y) {

  dat_y <- SEER__colorec_trends %>% 
    filter(year_of_diagnosis == y)

  fit_y <- coxph(
    Surv(survival_months_num, status_num) ~ race_f + sex_f + age_f,
    data = dat_y,
    ties = "efron"
  )

  broom::tidy(fit_y, exponentiate = TRUE, conf.int = TRUE) %>% 
    filter(grepl("^race_f", term)) %>%
    mutate(
      year_of_diagnosis = y,
      race = gsub("race_f", "", term)
    )
})
ggplot(yearly_results,
       aes(x = factor(year_of_diagnosis), 
           y = estimate,
           color = race, group = race)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Yearly Hazard Ratios by Race (Reference = NHW)",
    x = "Year of Diagnosis",
    y = "Hazard Ratio (log scale)",
    color = "Race"
  ) +
  scale_y_continuous(trans = "log") +
  theme_minimal(base_size = 14)
```
```{r}
parallel_test <- coxph(
  Surv(survival_months_num, status_num) ~ 
    race_f * year_of_diagnosis + sex_f + age_f,
  data = SEER__colorec_trends,
  ties = "efron"
)

summary(parallel_test)
```







